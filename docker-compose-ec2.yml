version: "3.9"

volumes:
  myvolume:

services:
  scala_dev:
    build:
      context: .
      dockerfile: Dockerfile-scala
    depends_on: 
      - postgres2
    ports:
      - "8300:8080"
    command: bash -c "export SETTINGS=devDocker; sbt 'runMain com.chrisgoldammer.cocktails.DataSetupDevMain'; sbt 'runMain com.chrisgoldammer.cocktails.Main'"

  scala_prod:
    build:
      context: .
      dockerfile: Dockerfile-scala
    ports:
      - "8080:8080"
    command: bash -c "export SETTINGS=prod; sbt 'runMain com.chrisgoldammer.cocktails.DataSetupProdMain'; sbt 'assembly'; java -cp target/scala-3.2.1/cocktails-assembly-0.0.2.jar com.chrisgoldammer.cocktails.Main"

  postgres2:
    build: 
      context: .
      dockerfile: Dockerfile-postgres
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_USER: postgres
      POSTGRES_DB: ingredients_dev
    ports:
      - "5433:5432"

  nginx:
    build:
      context: .
      dockerfile: Dockerfile-nginx
    ports:
      - "80:80"
    depends_on:
      - app_prod
    volumes:
      - myvolume:/usr/share/nginx/html
    command: bash -c 'cp /usr/share/nginx/html/index_prod.html /usr/share/nginx/html/index.html; nginx -g "daemon off;"'

  app_prod:
    build:
      context: .
      dockerfile: Dockerfile-app-prod
    volumes:
      - myvolume:/serve_content

  app_dev:
    build:
      context: .
      dockerfile: Dockerfile-app
    ports:
      - "8082:8082"
    command: npm run devDocker
    working_dir: /frontend
    depends_on:
      - postgres2
      - scala_dev
